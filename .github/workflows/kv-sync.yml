      - name: 找出本次改动的 m3u/txt/yaml 文件并上传
        env:
          KV_ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          KV_API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          git diff --name-only HEAD~1 HEAD > changed.txt || echo "首次运行，上传全部"

          if [ ! -s changed.txt ]; then
            echo "没有文件改动，跳过上传"
            exit 0
          fi

          echo "本次需要上传的文件：
          cat changed.txt

          count=0
          while IFS= read -r file; do
            [[ -f "$file" ]] || continue
            [[ "$file" =~ \.(m3u|txt|yaml|yml)$ ]] || continue

            key="${file#./}"
            encoded_key=$(printf '%s' "$key" | jq -Rr @uri)
            
            echo "正在上传第 $((++count)) 个：$key"
            
            curl -X PUT "https://api.cloudflare.com/client/v4/accounts/$KV_ACCOUNT_ID/storage/kv/namespaces/$KV_NAMESPACE_ID/values/$encoded_key" \
              -H "Authorization: Bearer $KV_API_TOKEN" \
              -H "Content-Type: text/plain" \
              --data-binary @"$file" \
              --fail --silent --show-error && echo "上传成功！" || echo "上传失败！"

            sleep 1.5
          done < changed.txt

          echo "全部完成！本次共上传 $count 个文件"
