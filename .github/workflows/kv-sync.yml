name: 【实验】上传单个测试文件到 KV（确诊专用）

on:
  workflow_dispatch:   # 只手动触发

jobs:
  test-upload-one-file:
    runs-on: ubuntu-latest
    steps:
      - name: 上传一个纯文本测试文件到你的 KV
        env:
          ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          echo "开始实验：尝试写入 key = test_github_actions ，value = hello world"

          # 直接写一个最简单的键值对
          if curl -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces/$NAMESPACE_ID/values/test_github_actions" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: text/plain" \
            --data "hello world from GitHub Actions $(date)" \
            --fail --silent --show-error; then
            echo "实验成功！你的 KV 完全正常，可以正常写入！"
            echo "说明之前的问题是脚本/路径/编码导致的"
          else
            echo "实验失败，返回了 429 或其他错误"
            echo "说明这个 KV Namespace 确实被 Cloudflare 临时限流/风控了"
            echo "建议：立刻换一个全新的 Namespace"
          fi
