name: 验证 Cloudflare KV Token 权限（一键三连）

on:
  workflow_dispatch:   # 只支持手动触发

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 验证 Account ID 是否正确
        env:
          ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
        run: |
          echo "正在验证 Account ID: $ACCOUNT_ID"
          if [[ -z "$ACCOUNT_ID" ]]; then
            echo "Account ID 为空！请检查 Secrets"
            exit 1
          fi
          echo "Account ID 格式正常"

      - name: 2. 验证 API Token 是否能正常认证
        env:
          API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          echo "正在验证 API Token 是否有效..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $API_TOKEN" \
            "https://api.cloudflare.com/client/v4/user/tokens/verify")
          
          if [[ "$RESPONSE" == "200" ]]; then
            echo "API Token 认证成功！"
          else
            echo "API Token 无效或无权限！状态码: $RESPONSE"
            exit 1
          fi

      - name: 3. 验证是否拥有指定 KV Namespace 的读写权限
        env:
          ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          echo "正在验证对 KV Namespace ($NAMESPACE_ID) 的读写权限..."
          
          # 先读（GET）
          GET=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces/$NAMESPACE_ID" \
            -H "Authorization: Bearer $API_TOKEN")
          
          # 再尝试写一个测试键（会自动覆盖，无副作用）
          WRITE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces/$NAMESPACE_ID/values/__github_actions_test_key__" \
            -H "Authorization: Bearer $API_TOKEN" \
            -H "Content-Type: text/plain" \
            --data "test")

          echo "$GET" | jq .

          if [[ "$WRITE" == "200" ]]; then
            echo "全部验证通过！你的 3 个 Secrets 完全正确且拥有 KV 读写权限！"
            echo "可以放心使用上传脚本了！"
          else
            echo "写权限验证失败！状态码: $WRITE"
            echo "请检查 Token 是否勾选了：Account → Workers KV Storage → Edit"
            exit 1
          fi
