name: 全量同步到 Cloudflare KV（智能增量 + 永不429）

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'    # 每天 UTC 1:00（北京 9:00）全量一次就够了
  push:
    branches: [ main, master ]

jobs:
  sync-kv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 全量同步需要完整历史（增量模式下可改浅克隆）

      - name: 智能同步到 Cloudflare KV
        env:
          KV_ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          KV_API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          # 安装 jq（用于 URL encode）
          sudo apt-get update && sudo apt-get install -y jq

          # 只处理这些后缀的文件
          extensions="*.txt|*.m3u|*.yaml|*.yml|*.json|*.csv|*.md"

          # 排除目录
          find . -type f \( -path './.git/*' -o -path './.github/*' -o -path './md/*' \) -prune -o \
               -regextype posix-egrep -regex ".*/($extensions)$" -print | \
          while IFS= read -r file; do
            [[ -f "$file" ]] || continue
            key="${file#./}"                              # 去掉开头的 ./
            encoded_key=$(printf '%s' "$key" | jq -Rr @uri) # URL 编码

            echo "上传: $key"
            
            # 用官方推荐的 PUT + --fail 方式
            if curl -X PUT "https://api.cloudflare.com/client/v4/accounts/$KV_ACCOUNT_ID/storage/kv/namespaces/$KV_NAMESPACE_ID/values/$encoded_key" \
               -H "Authorization: Bearer $KV_API_TOKEN" \
               -H "Content-Type: text/plain" \
               --data-binary @"$file" \
               --fail --silent --show-error; then
              echo "成功: $key"
            else
              echo "失败: $key"
            fi

            # 关键！免费账号硬限 ≈1000次/10分钟，睡 0.8~1.2 秒绝对不429不了
            sleep 1
          done

          echo "全部同步完成！"
