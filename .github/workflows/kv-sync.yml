jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 上传7个核心文件（最稳版）
        env:
          ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          FILES=(
            "output.m3u"
            "output_with_logo.m3u"
            "tvbox_output.txt"
            "missing_logos.txt"
            "README.md"
            "history/merged.m3u"
            "history/merged.txt"
          )

          echo "开始上传 ${#FILES[@]} 个文件..."

          SUCCESS=0
          for file in "${FILES[@]}"; do
            [[ ! -f "$file" ]] && { echo "跳过（不存在）：$file"; continue; }

            # KV Key 不需要开头的 './'，这里确保去除
            key="${file#./}"
            
            # 【核心修正】: 使用 Python 脚本进行 URL 编码，并将结果赋值给变量
            encoded_key=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${key}', safe=''))")

            # 检查编码结果，如果 Python 脚本失败，encoded_key可能为空
            if [[ -z "$encoded_key" ]]; then
                echo "错误：Python 编码失败或结果为空，跳过 $key"
                continue
            fi

            echo "正在上传 → $key (编码后: $encoded_key)"

            if curl -X PUT \
              "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces/$NAMESPACE_ID/values/$encoded_key" \
              -H "Authorization: Bearer $API_TOKEN" \
              -H "Content-Type: text/plain" \
              --data-binary @"$file" \
              --fail --silent --show-error; then
              echo "上传成功！"
              ((SUCCESS++))
            else
              echo "上传失败"
            fi

            sleep 3
          done

          echo "=========================================="
          echo "全部完成！成功 $SUCCESS / ${#FILES[@]} 个文件"        
          echo "=========================================="
