      - name: 终极安全上传（彻底杜绝 malformed）
        env:
          ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          # 强制上传的核心文件
          cat > force.txt << 'EOF'
          output.m3u
          output_with_logo.m3u
          tvbox_output.txt
          missing_logos.txt
          README.md
          EOF

          # merged 文件
          find history -maxdepth 1 -name "merged.*" -type f > merged.txt 2>/dev/null || true

          # 合并 + 去重
          {
            cat force.txt
            cat merged.txt
            git diff --name-only HEAD~1 HEAD 2>/dev/null || true
          } | grep -v "^$" | sort -u > upload_list.txt

          if [ ! -s upload_list.txt ]; then
            echo "没有需要上传的文件"
            exit 0
          fi

          echo "本次将上传 $(wc -l < upload_list.txt) 个文件："
          cat upload_list.txt | sed 's/^/  → /'

          SUCCESS=0
          while IFS= read -r file; do
            [[ -f "$file" ]] || continue

            # 关键修复：强制去掉开头的 ./
            KEY="${file#./}"
            # 再保险一次：把 .github 开头的路径改成合法的（Cloudflare KV 支持点，但不能以 . 开头作为 key）
            if [[ "$KEY" == .github/* ]]; then
              KEY="github_${KEY#.github/}"
            fi

            # 完美编码：用 python 替代 jq（永不 malformed！）
            ENCODED=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$KEY', safe=''))")

            echo "正在上传 → $KEY (编码后: $ENCODED)"

            for i in 1 2 3; do
              if curl -X PUT \
                "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces/$NAMESPACE_ID/values/$ENCODED" \
                -H "Authorization: Bearer $API_TOKEN" \
                -H "Content-Type: text/plain" \
                --data-binary @"$file" \
                --fail --silent --show-error; then
                echo "上传成功！"
                ((SUCCESS++))
                break
              else
                echo "第 $i 次失败，等待重试..."
                sleep $((i * 8))
              fi
            done

            sleep 3
            (( $(wc -l < upload_list.txt) > 3 && SUCCESS % 3 == 0 )) && sleep 15

          done < upload_list.txt

          echo "全部完成！成功 $SUCCESS 个文件"
