      - name: 终极防 malformed + 防429 上传
        env:
          ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          # 正确做法：用数组或换行，避免空格连在一起
          changed=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")

          # 强制上传的文件（每行一个！）
          printf "%s\n" \
            "output.m3u" \
            "output_with_logo.m3u" \
            "tvbox_output.txt" \
            "missing_logos.txt" \
            "README.md" > force_files.txt

          # merged 文件也每行一个
          find history -maxdepth 1 -name "merged.*" -type f -printf "%f\n" 2>/dev/null | sed 's|^|history/|' > merged_files.txt

          # 合并 + 去重 → 最终上传列表
          upload_list=$(cat force_files.txt merged_files.txt <(echo "$changed") | grep -v "^$" | sort -u)

          if [[ -z "$upload_list" ]]; then
            echo "没有需要上传的文件"
            exit 0
          fi

          echo "本次将上传 $(echo "$upload_list" | wc -l) 个文件："
          echo "$upload_list" | sed 's/^/  → /'

          count=0 success=0 fail=0
          while IFS= read -r file; do
            [[ -f "$file" ]] || continue

            key="${file#./}"
            # 关键修复：先清理 key，再编码
            key=$(echo "$key" | sed 's/^[.]\///')  # 去掉开头的 ./
            encoded_key=$(printf '%s' "$key" | jq -Rr @uri)

            echo "正在上传 ($((++count))) $key → $encoded_key"

            for attempt in 1 2 3; do
              if curl -X PUT \
                "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces/$NAMESPACE_ID/values/$encoded_key" \
                -H "Authorization: Bearer $API_TOKEN" \
                -H "Content-Type: text/plain" \
                --data-binary @"$file" \
                --fail --silent --show-error; then
                echo "上传成功！"
                ((success++))
                break
              else
                echo "第 $attempt 次失败，等待重试..."
                sleep $((attempt * 8))
              fi
            done

            sleep 2.5
            (( count % 3 == 0 )) && sleep 15

          done <<< "$upload_list"

          echo "上传完成！成功 $success，失败 $fail"
