name: 上传 7 个核心文件到 Cloudflare KV（新账号专用）

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  upload-7-files:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4

      - name: 上传 7 个核心文件到 KV（永不 429）
        env:
          ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          # 这 7 个文件每次都强制上传（核心文件必须最新）
          FILES=(
            "output.m3u"
            "output_with_logo.m3u"
            "tvbox_output.txt"
            "missing_logos.txt"
            "README.md"
            "history/merged.m3u"
            "history/merged.txt"
          )

          echo "开始上传 ${#FILES[@]} 个核心文件..."

          SUCCESS=0
          for file in "${FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "跳过（文件不存在）：$file"
              continue
            fi

            key="$file"
            # 用最稳的 Python 编码（永不 malformed）
            encoded_key=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote('$key', safe=''))")

            echo "正在上传 → $file"

            if curl -X PUT \
              "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces/$NAMESPACE_ID/values/$encoded_key" \
              -H "Authorization: Bearer $API_TOKEN" \
              -H "Content-Type: text/plain" \
              --data-binary @"$file" \
              --fail --silent --show-error; then
              echo "上传成功！"
              ((SUCCESS++))
            else
              echo "上传失败（网络波动）"
            fi

            # 新账号也保险起见，稳一点
            sleep 2
          done

          echo "=========================================="
          echo "全部完成！成功上传 $SUCCESS / ${#FILES[@]} 个文件"
          echo "你的 KV 已满血复活，完美同步！"
          echo "=========================================="
