name: 同步到 Cloudflare KV（2025最新稳版）

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 上传文件到 Cloudflare KV（已修复404）
        env:
          ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          shopt -s globstar nullglob

          pattern='*.txt *.m3u *.m3u8 *.yaml *.yml *.json *.csv *.md'
          count=0

          for file in **/$pattern; do
            # 排除目录
            if [[ "$file" == .git/* ]] || [[ "$file" == .github/* ]] || [[ "$file" == md/* ]]; then
              echo "跳过: $file"
              continue
            fi

            [[ -f "$file" ]] || continue

            key="$file"
            encoded_key=$(printf '%s' "$key" | jq -Rr @uri)

            echo "正在上传 ($((++count))) $key → $encoded_key"

            # 关键！去掉多余的 /storage
            curl -X PUT "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces/$NAMESPACE_ID/values/$encoded_key" \
              -H "Authorization: Bearer $API_TOKEN" \
              -H "Content-Type: text/plain" \
              --data-binary @"$file" \
              --fail --silent --show-error && \
              echo "上传成功！" || { echo "上传失败！"; exit 1; }

            sleep 1.1
          done

          echo "全部上传完成！共处理 $count 个文件"
