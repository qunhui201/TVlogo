name: 智能增量同步到 Cloudflare KV（永不 malformed）

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 上传到 Cloudflare KV（永不 malformed + 防 429）
        env:
          ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          # 强制上传的核心文件
          cat > /tmp/force.txt << 'EOF'
          output.m3u
          output_with_logo.m3u
          tvbox_output.txt
          missing_logos.txt
          README.md
          EOF

          # merged 文件
          find history -maxdepth 1 -name "merged.*" -type f > /tmp/merged.txt 2>/dev/null || true

          # 合并 + 去重 + 完全排除 .github
          {
            cat /tmp/force.txt
            cat /tmp/merged.txt
            git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -v '^\.github/' || true
          } | grep -v "^$" | sort -u > /tmp/upload.txt

          if [ ! -s /tmp/upload.txt ]; then
            echo "没有需要上传的文件"
            exit 0
          fi

          echo "本次将上传 $(wc -l < /tmp/upload.txt) 个文件："
          cat /tmp/upload.txt | sed 's/^/  → /'

          SUCCESS=0
          while IFS= read -r file; do
            [[ -f "$file" ]] || continue

            # 关键修复：用 bash 内置 + printf 完美编码（永不 malformed！）
            key="${file#./}"
            # 手动 URL 编码（最稳！）
            encoded_key=$(printf '%s' "$key" | jq -s -R -r @uri)

            echo "正在上传 → $key (编码: $encoded_key)"

            if curl -X PUT \
              "https://api.cloudflare.com/client/v4/accounts/$ACCOUNT_ID/storage/kv/namespaces/$NAMESPACE_ID/values/$encoded_key" \
              -H "Authorization: Bearer $API_TOKEN" \
              -H "Content-Type: text/plain" \
              --data-binary @"$file" \
              --fail --silent --show-error; then
              echo "上传成功！"
              ((SUCCESS++))
            else
              echo "上传失败"
            fi

            sleep 4
          done < /tmp/upload.txt

          echo "=========================================="
          echo "全部完成！成功 $SUCCESS 个文件"
          echo "=========================================="
