name: Build M3U Playlist

on:
  workflow_dispatch:
  schedule:
    - cron: "30 */4 * * *"   # ÊØè4Â∞èÊó∂ËøêË°å‰∏ÄÊ¨°

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: üßπ Âà†Èô§ÊóßÁöÑËæìÂá∫Êñá‰ª∂
        run: |
          cd /home/runner/work/TVlogo/TVlogo
          echo "üßπ Âà†Èô§ÊóßÁöÑËæìÂá∫Êñá‰ª∂..."
          rm -f output.m3u output_with_logo.m3u tvbox_output.txt
          ls -l --time-style=long-iso

      - name: üß© ËøêË°å Python ÁîüÊàêÊñá‰ª∂
        run: |
          cd /home/runner/work/TVlogo/TVlogo
          python3 md/build_m3u.py

      # ‚úÖ Êñ∞Â¢ûÔºöÂº∫Âà∂Âà∑Êñ∞Êó∂Èó¥Êà≥ÔºàÂç≥‰ΩøÂÜÖÂÆπÊ≤°ÂèòÔºâ
      - name: ‚è∞ Âº∫Âà∂Âà∑Êñ∞Ê†πÁõÆÂΩïËæìÂá∫Êñá‰ª∂Êó∂Èó¥Êà≥
        run: |
          cd /home/runner/work/TVlogo/TVlogo
          for f in output.m3u output_with_logo.m3u tvbox_output.txt; do
            if [ -f "$f" ]; then
              echo "" >> "$f"
              sed -i '$d' "$f"
            fi
          done
          echo "üìÑ Êñá‰ª∂Êó∂Èó¥Êà≥Â∑≤Âà∑Êñ∞Ôºö"
          ls -l --time-style=long-iso output.m3u output_with_logo.m3u tvbox_output.txt || true

      - name: üóÉÔ∏è ‰øùÂ≠òÂà∞ history/
        run: |
          cd /home/runner/work/TVlogo/TVlogo
          TIMESTAMP=$(date +"%m%d%H%M")
          cp output.m3u history/${TIMESTAMP}.m3u
          cp output_with_logo.m3u history/logo${TIMESTAMP}.m3u
          cp tvbox_output.txt history/tvbox_${TIMESTAMP}.txt
          echo "‚úÖ Â∑≤‰øùÂ≠òÂà∞ history/Ôºö"
          echo " - ${TIMESTAMP}.m3u"
          echo " - logo${TIMESTAMP}.m3u"
          echo " - tvbox_${TIMESTAMP}.txt"

      - name: Commit and Push
        run: |
          cd /home/runner/work/TVlogo/TVlogo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add history/
          git commit -m "Auto build M3U & TVBox files $(date +"%m%d%H%M") [skip ci]" || echo "no changes"
          git push

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: m3u-playlist-${{ github.run_id }}
          path: |
            output.m3u
            output_with_logo.m3u
            tvbox_output.txt
            history/
