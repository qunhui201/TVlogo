name: 只砍斜杠套娃（一次彻底解决）

on: workflow_dispatch

jobs:
  clean:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: 一次性砍掉所有多余斜杠和套娃
        run: |
          find . -type f \( -name "*.m3u" -o -name "*.txt" -o -name "*.yaml" -o -name "*.yml" \) -print0 | while IFS= read -r -d '' file; do
            echo "正在砍: $file"
            
            # 只干这一件事：反复把 kenyu.ggff.net 后面所有 ////// 砍到只剩一个 /
            sed -i 's|kenyu\.ggff\.net/\+|kenyu.ggff.net/|g' "$file"
            
            # 再把 raw 前面的 ////// 也砍干净
            sed -i 's|https:/\+|https://|g' "$file"
          done

      - name: 提交
        run: |
          git config user.name "clean-bot"
          git config user.email "clean@github.com"
          git add .
          git commit -m "砍掉所有多余斜杠，链接恢复正常" || echo "无改动"
          git push
