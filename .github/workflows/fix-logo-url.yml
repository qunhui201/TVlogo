name: 终极修复台标链接（去重+防套娃）

on: workflow_dispatch

jobs:
  fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: 终极清洗台标链接（去掉所有多余套娃）
        run: |
          find . -type f \( -name "*.m3u" -o -name "*.txt" -o -name "*.yaml" -o -name "*.yml" \) -print0 | while IFS= read -r -d '' file; do
            echo "清洗: $file"

            # 核心：反复去掉多余的 kenyu.ggff.net 前缀，直到只剩一个
            while grep -q "kenyu\.ggff\.net.*kenyu\.ggff\.net" "$file"; do
              sed -i 's|kenyu\.ggff\.net/https:/|kenyu.ggff.net/https://|g' "$file"
              sed -i 's|kenyu\.ggff\.net//|kenyu.ggff.net/|g' "$file"
            done

            # 最终统一成你想要的正确格式（只保留一个 kenyu 前缀）
            sed -i 's|https://raw\.githubusercontent\.com/qunhui201/logo/main/TVlogo_Images|https://kenyu.ggff.net/https://raw.githubusercontent.com/qunhui201/logo/main/TVlogo_Images|g' "$file"

            # 顺便把 jsDelivr 的也干掉
            sed -i 's|https://cdn\.jsdelivr\.net/gh/qunhui201/logo@TVlogo_Images|https://kenyu.ggff.net/https://raw.githubusercontent.com/qunhui201/logo/main/TVlogo_Images|g' "$file"
          done

      - name: 提交清洗结果
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "终极清洗：去掉台标链接套娃，只保留一个 kenyu.ggff.net" || echo "无改动"
          git push origin main
