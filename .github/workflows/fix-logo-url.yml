name: 终极清洗台标链接套娃（一次搞定）

on: workflow_dispatch

jobs:
  clean:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}   # 确保你已经添加了这个 Secret

      - name: 彻底清洗套娃 + 统一为 kenyu.ggff.net 加速链接
        run: |
          find . -type f \( -name "*.m3u" -o -name "*.txt" -o -name "*.yaml" -o -name "*.yml" \) -print0 | while IFS= read -r -d '' file; do
            echo "正在清洗: $file"

            # 第一步：把所有连续出现的 kenyu.ggff.net/https:// 合并成一个
            # 只要还有两个 kenyu 就一直替换，直到只剩一个（最多循环 10 次，防止意外）
            for i in {1..10}; do
              if ! grep -q "kenyu\.ggff\.net.*kenyu\.ggff\.net" "$file"; then
                break
              fi
              sed -i 's|kenyu\.ggff\.net/https:/|kenyu.ggff.net/https://|g' "$file"
              sed -i 's|kenyu\.ggff\.net//|kenyu.ggff.net/|g' "$file"
            done

            # 第二步：把原始 raw 链接统一换成正确的一层 kenyu 加速链接
            sed -i 's|https://raw\.githubusercontent\.com/qunhui201/logo/main/TVlogo_Images|https://kenyu.ggff.net/https://raw.githubusercontent.com/qunhui201/logo/main/TVlogo_Images|g' "$file"

            # 第三步：把 jsDelivr 的也换掉（防止漏的）
            sed -i 's|https://cdn\.jsdelivr\.net/gh/qunhui201/logo@TVlogo_Images|https://kenyu.ggff.net/https://raw.githubusercontent.com/qunhui201/logo/main/TVlogo_Images|g' "$file"
          done

      - name: 提交清洗结果
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "终极清洗：台标链接套娃已清除，只保留一层 kenyu.ggff.net" || echo "没有改动"
          git push origin main
