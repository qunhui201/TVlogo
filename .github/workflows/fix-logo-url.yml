name: 修复台标链接 → kenyu.ggff.net 加速版（私库专用）

on:
  workflow_dispatch:   # 手动触发

jobs:
  fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # 修改文件
      workflows: write    # 允许修改 .github/workflows 目录（关键！）

    steps:
      - name: Checkout 仓库（使用有写权限的 PAT）
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}   # 这里用你刚加的 PAT

      - name: 修复双斜杠 + 替换为 kenyu.ggff.net 加速链接
        run: |
          find . -type f \( -name "*.m3u" -o -name "*.txt" -o -name "*.yaml" -o -name "*.yml" \) -print0 | while IFS= read -r -d '' file; do
            echo "处理: $file"
            
            # 1. 先干掉所有双斜杠
            sed -i 's|kenyu\.ggff\.net//|kenyu.ggff.net/|g' "$file"
            
            # 2. 把所有旧路径换成你想要的 kenyu 加速版
            sed -i 's|https://raw\.githubusercontent\.com/qunhui201/logo/main/TVlogo_Images|https://kenyu.ggff.net/https://raw.githubusercontent.com/qunhui201/logo/main/TVlogo_Images|g' "$file"
            
            # 3. 把 jsDelivr 的也一起换掉（防止漏的）
            sed -i 's|https://cdn\.jsdelivr\.net/gh/qunhui201/logo@TVlogo_Images|https://kenyu.ggff.net/https://raw.githubusercontent.com/qunhui201/logo/main/TVlogo_Images|g' "$file"
          done

      - name: 提交并推送到 main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "修复台标链接 → kenyu.ggff.net 加速版（已修正双斜杠）" || echo "没有改动"
          git push origin main
