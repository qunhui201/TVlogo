name: 砍掉多余的 kenyu.ggff.net 前缀（只留一个）

on: workflow_dispatch

jobs:
  clean:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: 砍掉所有多余的 kenyu.ggff.net 前缀
        run: |
          find . -type f \( -name "*.m3u" -o -name "*.txt" -o -name "*.yaml" -o -name "*.yml" \) -print0 | while IFS= read -r -d '' file; do
            echo "正在砍前缀: $file"
            
            # 只要还有两个 kenyu.ggff.net，就一直砍，直到只剩一个
            while grep -q "kenyu\.ggff\.net.*kenyu\.ggff\.net" "$file"; do
              sed -i 's|kenyu\.ggff\.net/https:/|kenyu.ggff.net/https://|g' "$file"
              sed -i 's|kenyu\.ggff\.net/https://raw|https://raw|g' "$file"
            done
          done

      - name: 提交
        run: |
          git config user.name "clean-bot"
          git config user.email "clean@github.com"
          git add .
          git commit -m "砍掉多余 kenyu.ggff.net 前缀，只保留一个" || echo "无改动"
          git push
