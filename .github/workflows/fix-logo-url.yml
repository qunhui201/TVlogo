name: 修复台标链接 → kenyu.ggff.net 加速版

on: workflow_dispatch   # 手动触发

jobs:
  fix:
    runs-on: ubuntu-latest
    
    # 关键：给完整写权限（新语法，旧的 workflows: write 已经不被所有仓库接受）
    permissions:
      contents: write
      actions: write          # 替代 workflows: write
      checks: write

    steps:
      - name: Checkout 仓库（使用有写权限的 PAT）
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}   # 必须是你刚才新建的 repo 权限 PAT

      - name: 修复双斜杠 + 替换为 kenyu.ggff.net 加速链接
        run: |
          find . -type f \( -name "*.m3u" -o -name "*.txt" -o -name "*.yaml" -o -name "*.yml" \) -print0 | xargs -0 -I {} sh -c '
            echo "处理: {}"
            # 1. 干掉所有双斜杠
            sed -i "s|kenyu\.ggff\.net//|kenyu.ggff.net/|g" "{}"
            # 2. 替换所有旧路径为 kenyu 加速版
            sed -i "s|https://raw\.githubusercontent\.com/qunhui201/logo/main/TVlogo_Images|https://kenyu.ggff.net/https://raw.githubusercontent.com/qunhui201/logo/main/TVlogo_Images|g" "{}"
            # 3. 把 jsDelivr 的也一起干掉
            sed -i "s|https://cdn\.jsdelivr\.net/gh/qunhui201/logo@TVlogo_Images|https://kenyu.ggff.net/https://raw.githubusercontent.com/qunhui201/logo/main/TVlogo_Images|g" "{}"
          '

      - name: 提交并推送到 main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "修复台标链接 → kenyu.ggff.net 加速版（已修正双斜杠）" || echo "没有改动"
          git push origin main
