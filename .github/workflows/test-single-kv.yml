name: 测试上传单个文件（确认 token 正确）

on: workflow_dispatch

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 上传 history/merged.m3u（真实路径）测试 token
        env:
          KV_ACCOUNT_ID: ${{ secrets.KV_ACCOUNT_ID }}
          KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
          KV_API_TOKEN: ${{ secrets.KV_API_TOKEN }}
        run: |
          FILE="history/merged.m3u"          # 真实路径！
          KEY="history/merged.m3u"           # 你想在 KV 里用的 key（可以一样）

          echo "检查文件是否存在..."
          ls -la "$FILE" || exit 1

          echo "正在上传 $FILE → KV key: $KEY"

          curl -X PUT \
            "https://api.cloudflare.com/client/v4/accounts/$KV_ACCOUNT_ID/storage/kv/namespaces/$KV_NAMESPACE_ID/values/$KEY" \
            -H "Authorization: Bearer $KV_API_TOKEN" \
            -H "Content-Type: text/plain" \
            --data-binary @"$FILE" \
            -w "\nHTTP_STATUS: %{http_code}\n" -s -o response.json

          echo "=== Cloudflare 返回 ==="
          cat response.json

          if grep -q '"success":true' response.json; then
            echo "上传成功！你的 3 个 token 完全正确！"
          else
            echo "上传失败，token 或权限有问题"
          fi
